// components/MathKeyboard.ets
import { display } from '@kit.ArkUI'; // ã€æ–°å¢žã€‘å¼•å…¥ display æ¨¡å—
import { KeyModel } from '../model/KeyModel';
import { MathKey } from './MathKey';
import { CalculatorStore } from '../viewmodel/CalculatorStore';
import { PopupUiState, popupUiState } from '../viewmodel/PopupUiState';
import { MAPLE_KEYS } from '../model/KeyConfig';

// å¸¸é‡å®šä¹‰
const CELL_WIDTH = 50;
const CELL_HEIGHT = 50;
const POPUP_OFFSET_Y = 60;

interface MyPosition {
  x: number;
  y: number;
}

@Component
export struct MathKeyboard {
  @ObjectLink store: CalculatorStore;
  @State popupState: PopupUiState = popupUiState;

  // ã€æ–°å¢žã€‘é”®ç›˜å®¹å™¨è‡ªèº«çš„å…¨å±€ä½ç½®ï¼Œç”¨äºŽåæ ‡ä¿®æ­£
  @State keyboardGlobalPos: MyPosition = { x: 0, y: 0 };

  // ã€ä¿®æ”¹ã€‘å±å¹•å®½åº¦åˆå§‹åŒ–ä¸º 0ï¼Œç¨åŽèŽ·å–
  @State screenWidth: number = 0;

  // ã€æ–°å¢žã€‘ç»„ä»¶åŠ è½½æ—¶èŽ·å–çœŸå®žå±å¹•å®½åº¦
  aboutToAppear() {
    try {
      const displayClass = display.getDefaultDisplaySync();
      this.screenWidth = displayClass.width;
      // æ³¨æ„ï¼šå¦‚æžœæ˜¯ vp å•ä½ï¼Œå¯èƒ½éœ€è¦ px2vp è½¬æ¢ï¼Œ
      // ä½† display.width é€šå¸¸è¿”å›ž pxã€‚ArkUI çš„ position é»˜è®¤å•ä½æ˜¯ vpã€‚
      // ä¸ºäº†ç¨³å¦¥ï¼Œæˆ‘ä»¬å¯ä»¥å‡è®¾è¿™é‡Œéƒ½ç”¨ vp æˆ–è€…ç»Ÿä¸€è½¬æ¢ã€‚
      // åœ¨ API 10+ ä¸­ï¼Œdisplay.width æ˜¯ pxã€‚
      // å¦‚æžœä½ çš„å¸ƒå±€ä¹±äº†ï¼Œè¿™é‡Œå¯èƒ½éœ€è¦ px2vp(displayClass.width)
      // ä½†é€šå¸¸ onAreaChange ç»™å‡ºçš„ globalPosition ä¹Ÿæ˜¯ px (å–å†³äºŽç³»ç»Ÿè®¾ç½®)ï¼Œ
      // åªè¦å•ä½ç»Ÿä¸€å³å¯ã€‚è¿™é‡Œæˆ‘ä»¬æš‚æ—¶ç›´æŽ¥ä½¿ç”¨ï¼Œå¦‚æžœåå¤§åˆ™åŠ ä¸Š px2vpã€‚
      this.screenWidth = px2vp(displayClass.width);
    } catch (err) {
      console.error('Failed to obtain the screen width:', JSON.stringify(err));
      this.screenWidth = 360; // é™çº§é»˜è®¤å€¼
    }
  }

  // è®¡ç®—å¼¹çª—æ˜¾ç¤ºçš„ X åæ ‡ (ç›¸å¯¹äºŽ Keyboard Stack)
  private getPopupX(): number {
    if (!this.popupState.sourceKey || !this.popupState.sourceKey.variants) {
      return 0;
    }

    const variantsCount = this.popupState.sourceKey.variants.length;
    const totalWidth = variantsCount * CELL_WIDTH;

    // 1. èŽ·å–æŒ‰é”®çš„å…¨å±€ X
    let globalX = this.popupState.positionX;

    // 2. è¾¹ç¼˜æ£€æµ‹ (åŸºäºŽå…¨å±€åæ ‡å’Œå±å¹•å®½åº¦)
    // å¦‚æžœ (å¼¹çª—å…¨å±€X + å¼¹çª—å®½) > å±å¹•å®½ï¼Œåˆ™å‘å·¦åç§»
    if (globalX + totalWidth > this.screenWidth - 10) {
      globalX = (this.screenWidth - totalWidth - 10);
    }
    if (globalX < 10) globalX = 10;

    // 3. ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šè½¬æ¢ä¸ºå±€éƒ¨åæ ‡
    // å±€éƒ¨ X = ç›®æ ‡å…¨å±€ X - é”®ç›˜å®¹å™¨å…¨å±€ X
    return globalX - this.keyboardGlobalPos.x;
  }

  // è®¡ç®—å¼¹çª—æ˜¾ç¤ºçš„ Y åæ ‡ (ç›¸å¯¹äºŽ Keyboard Stack)
  private getPopupY(): number {
    // ç›®æ ‡å…¨å±€ Y = æŒ‰é”®å…¨å±€ Y - åç§»é‡
    const targetGlobalY = this.popupState.positionY - POPUP_OFFSET_Y;

    // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šè½¬æ¢ä¸ºå±€éƒ¨åæ ‡
    // å±€éƒ¨ Y = ç›®æ ‡å…¨å±€ Y - é”®ç›˜å®¹å™¨å…¨å±€ Y
    return targetGlobalY - (this.keyboardGlobalPos.y || 0);
  }

  build() {
    Stack() {
      Column() {
        // --- Top Bar (é€»è¾‘ä¸å˜) ---
        Row() {
          this.TopBarButton("fâˆ«âˆ‘", () => { })
          this.TopBarButton("abc", () => { })
          Blank()
          this.TopBarButton("â†¶", () => { this.store.undo(); })
          this.TopBarButton("â†·", () => { this.store.redo(); })
          this.TopBarButton("ðŸ—‘", () => { this.store.clearAll(); })
        }
        .width('100%')
        .height(45)
        .backgroundColor('#1E1E1E')
        .padding({ left: 5, right: 5 })
        .alignItems(VerticalAlign.Center)

        // --- Grid Area ---
        Grid() {
          ForEach(MAPLE_KEYS, (keyItem: KeyModel) => {
            GridItem() {
              MathKey({
                item: keyItem,
                customBgColor: keyItem.bgColor,
                customTextColor: keyItem.textColor || '#FFFFFF',
                onKeyPress: (k): void => this.store.handleInput(k)
              })
            }
          })
        }
        .columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr')
        .rowsTemplate('1fr 1fr 1fr 1fr 1fr')
        .rowsGap(1)
        .columnsGap(1)
        .width('100%')
        .layoutWeight(1)
        .backgroundColor('#1E1E1E')
        .padding(4)
      }
      .width('100%')
      .height(300)
      .backgroundColor('#1E1E1E')

      // --- å¼¹çª— Overlay ---
      if (this.popupState.isVisible && this.popupState.sourceKey && this.popupState.sourceKey.variants) {
        this.VariantPopupBuilder()
      }
    }
    .alignContent(Alignment.TopStart) // ç¡®ä¿å®šä½ä»Žå·¦ä¸Šè§’å¼€å§‹ç®—
    // ã€æ–°å¢žã€‘ï¼šç›‘å¬é”®ç›˜å®¹å™¨è‡ªèº«çš„å…¨å±€ä½ç½®
    .onAreaChange((oldValue, newValue) => {
      this.keyboardGlobalPos = {
        x: newValue.globalPosition.x as number,
        y: newValue.globalPosition.y as number
      };
    })
  }

  @Builder
  VariantPopupBuilder() {
    Row() {
      if (this.popupState.sourceKey && this.popupState.sourceKey.variants) {
        ForEach(this.popupState.sourceKey.variants, (item: KeyModel, index: number) => {
          Stack({ alignContent: Alignment.Center }) {
            Text(item.label)
              .fontSize(22)
              .fontColor('#FFF')
              .fontWeight(FontWeight.Medium)
          }
          .width(CELL_WIDTH)
          .height(CELL_HEIGHT)
          .backgroundColor(index === this.popupState.selectedIndex ? '#2D9CDB' : 'transparent')
          .borderRadius(4)
        })
      }
    }
    .height(CELL_HEIGHT)
    .backgroundColor('#333333')
    .borderRadius(8)
    .shadow({ radius: 10, color: 'rgba(0,0,0,0.5)', offsetY: 4 })
    .position({
      x: this.getPopupX(), // ä½¿ç”¨è½¬æ¢åŽçš„å±€éƒ¨åæ ‡
      y: this.getPopupY()
    })
    .zIndex(999)
  }

  @Builder TopBarButton(text: string, action: () => void) {
    Button({ type: ButtonType.Normal, stateEffect: true }) {
      Text(text).fontColor('#FFFFFF').fontSize(16).fontWeight(FontWeight.Medium)
    }
    .backgroundColor('transparent')
    .width(50)
    .height('100%')
    .onClick(() => { action(); })
  }
}